---
apiVersion: v1
kind: Namespace
metadata:
  name: sysdig-agent
---
apiVersion: v1
kind: Secret
metadata:
  name: sysdig-agent
  namespace: sysdig-agent
  labels:
    app: sysdig-agent
type: Opaque
data:
  # This is not a valid agent key! You should create your own, e.g.:
  #
  #     $ kubectl delete secret sysdig-agent --namespace=custom-metrics
  #
  #     $ kubectl create secret generic sysdig-agent \
  #           --namespace=custom-metrics \
  #           --from-literal=token=<YOUR OWN KEY>
  #
  #     $ kubectl get secret sysdig-agent -o json
  #
  # You could also encode the key from the command-line interface and edit the
  # object manually, e.g.:
  #
  #   $ echo -n "59493980-bbab-44e5-81b2-d80d59192fcd" | base64
  #   NTk0OTM5ODAtYmJhYi00NGU1LTgxYjItZDgwZDU5MTkyZmNk
  #
  #   $ env KUBE_EDITOR=vim kubectl edit secret sysdig-agent
  #
  # This is not a real token!
  access-key: NTk0OTM5ODAtYmJhYi00NGU1LTgxYjItZDgwZDU5MTkyZmNk
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sysdig-account
  namespace: sysdig-agent
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: sysdig-cluster-role
  namespace: sysdig-agent
rules:
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]
  - nonResourceURLs: ["*"]
    verbs: ["*"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: sysdig-cluster-role-binding
  namespace: sysdig-agent
subjects:
  - kind: ServiceAccount
    name: sysdig-account
    namespace: sysdig-agent
roleRef:
  kind: ClusterRole
  name: sysdig-cluster-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: sysdig-agent
  namespace: sysdig-agent
  labels:
    app: sysdig-agent
spec:
  template:
    metadata:
      name: sysdig-agent
      labels:
        app: sysdig-agent
    spec:
      volumes:
        - name: dshm
          emptyDir:
            medium: Memory
        - name: docker-sock
          hostPath:
            path: /var/run/docker.sock
        - name: dev-vol
          hostPath:
            path: /dev
        - name: proc-vol
          hostPath:
            path: /proc
        - name: boot-vol
          hostPath:
            path: /boot
        - name: modules-vol
          hostPath:
            path: /lib/modules
        - name: usr-vol
          hostPath:
            path: /usr
      hostNetwork: true
      hostPID: true
      tolerations:
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
      serviceAccountName: sysdig-account                       #OPTIONAL - OpenShift service account for OpenShift
      containers:
        - name: sysdig-agent
          image: sysdig/agent
          imagePullPolicy: Always                            #OPTIONAL - Always pull the latest container image tag
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 768Mi
          securityContext:
            privileged: true
          env:
            - name: ACCESS_KEY                                  #REQUIRED - replace with your Sysdig Cloud access key
              valueFrom:
                secretKeyRef:
                  name: sysdig-agent
                  key: access-key
            #        - name: RUN_MODE                                   #OPTIONAL - driverless mode (limited functionality. No kernel module. Minimum agent version 0.51.0)
            #          value: "nodriver"
            #        - name: COLLECTOR_PORT                             #OPTIONAL - on-prem install only
            #          value: "6443"
            #- name: TAGS
            #  value: dept:dev
          #        - name: COLLECTOR                                  #OPTIONAL - on-prem install only
          #          value: 192.168.183.200
          #        - name: SECURE                                     #OPTIONAL - on-prem install only
          #          value: false
          #        - name: CHECK_CERTIFICATE                          #OPTIONAL - on-prem install only
          #          value: false
          #        - name: ADDITIONAL_CONF                            #OPTIONAL pass additional parameters to the agent such as authentication example provided here
          #          value: "k8s_uri: https://myacct:mypass@localhost:4430\nk8s_ca_certificate: k8s-ca.crt\nk8s_ssl_verify_certificate: true"
          volumeMounts:
            - mountPath: /host/var/run/docker.sock
              name: docker-sock
              readOnly: false
            - mountPath: /host/dev
              name: dev-vol
              readOnly: false
            - mountPath: /host/proc
              name: proc-vol
              readOnly: true
            - mountPath: /host/boot
              name: boot-vol
              readOnly: true
            - mountPath: /host/lib/modules
              name: modules-vol
              readOnly: true
            - mountPath: /host/usr
              name: usr-vol
              readOnly: true
            - mountPath: /dev/shm
              name: dshm
